import { describe, expect, test } from '@jest/globals'
import { changePacketHostname } from '../src/common/fake-util'

const lobbyClientGameLoadedPacket = {
  id: 'vr0xw40rkp',
  type: 'lobby.appEvent',
  args: {
    type: 'CLIENT_GAME_LOADED',
    value: {
      channel: 'PCMac',
      currency: '',
      inGame: false,
      orientation: 'landscape',
      attributionId: 'dRFCoCi3ju2JScBPEoAGBmAIIq965wENvXF9Atv2+7Q=',
      ua_launch_id: null,
      lobby_launch_id: null,
      typeApp: 'lobby',
      provider: 'evolution',
      buildId: '6.20240325.123015.40308-372eee56ec',
      userAgent:
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0',
      url: 'https://localhost/frontend/everest/hotfix-release/#category=top_games&EVOSESSIONID=***&lang=ko&locale=ko',
      isIframe: false,
      swipeToPlayEnabled: true,
      virtualTableId: '',
      loaderSentLogCount: 1,
      clientTime: 1711621759216,
      browserSupportES2018: true,
      browserSupportES2018RegExp: true,
      browserSupportES2019: true,
      browserSupportES2020: true,
      browserSupportES2021: true,
      browserSupportWebAssembly: true,
      browserSupportWebP: true,
      browserSupportAvif: true,
      browserSupportCurrencyFormat: true,
      browserSupportBigInt: true,
    },
  },
}

const lobbyClientGameLoadedExpectPacket = {
  id: 'vr0xw40rkp',
  type: 'lobby.appEvent',
  args: {
    type: 'CLIENT_GAME_LOADED',
    value: {
      channel: 'PCMac',
      currency: '',
      inGame: false,
      orientation: 'landscape',
      attributionId: 'dRFCoCi3ju2JScBPEoAGBmAIIq965wENvXF9Atv2+7Q=',
      ua_launch_id: null,
      lobby_launch_id: null,
      typeApp: 'lobby',
      provider: 'evolution',
      buildId: '6.20240325.123015.40308-372eee56ec',
      userAgent:
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0',
      url: 'https://babylonrd.evo-games.com/frontend/everest/hotfix-release/#category=top_games&EVOSESSIONID=***&lang=ko&locale=ko',
      isIframe: false,
      swipeToPlayEnabled: true,
      virtualTableId: '',
      loaderSentLogCount: 1,
      clientTime: 1711621759216,
      browserSupportES2018: true,
      browserSupportES2018RegExp: true,
      browserSupportES2019: true,
      browserSupportES2020: true,
      browserSupportES2021: true,
      browserSupportWebAssembly: true,
      browserSupportWebP: true,
      browserSupportAvif: true,
      browserSupportCurrencyFormat: true,
      browserSupportBigInt: true,
    },
  },
}

const lobbyClientLobbyOpenedPacket = {
  id: 'keuxpv2rdc',
  type: 'lobby.appEvent',
  args: {
    type: 'CLIENT_LOBBY_OPENED',
    value: {
      product: 'live_lobby',
      screen: 'Browse',
      categoryId: 'top_games',
      channel: 'PCMac',
      inGame: false,
      layoutBreakpoint: 'MD',
      orientation: 'landscape',
      balance: null,
      currency: '₩',
      ingameMissedConfigId: null,
      screenHeight: 1032,
      screenSize: '1032x1268',
      screenWidth: 1268,
      tableId: '',
      url: 'https://localhost/frontend/everest/hotfix-release/#category=top_games&EVOSESSIONID=***&lang=ko&locale=ko',
      userAgent:
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0',
    },
  },
}
const lobbyClientLobbyOpenedExpectPacket = {
  id: 'keuxpv2rdc',
  type: 'lobby.appEvent',
  args: {
    type: 'CLIENT_LOBBY_OPENED',
    value: {
      product: 'live_lobby',
      screen: 'Browse',
      categoryId: 'top_games',
      channel: 'PCMac',
      inGame: false,
      layoutBreakpoint: 'MD',
      orientation: 'landscape',
      balance: null,
      currency: '₩',
      ingameMissedConfigId: null,
      screenHeight: 1032,
      screenSize: '1032x1268',
      screenWidth: 1268,
      tableId: '',
      url: 'https://babylonrd.evo-games.com/frontend/everest/hotfix-release/#category=top_games&EVOSESSIONID=***&lang=ko&locale=ko',
      userAgent:
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0',
    },
  },
}

const lobbyAppLoadingTimeV2Packet = {
  id: 'pk0p4kgu8u',
  type: 'lobby.appEvent',
  args: {
    type: 'CLIENT_APP_LOADING_TIME_V2',
    value: {
      userAgent:
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0',
      version: 14,
      game: 'smart-lobby',
      device: 'desktop',
      connectionType: '4g',
      build: '6.20240325.123015.40308-372eee56ec',
      attributionId: 'dRFCoCi3ju2JScBPEoAGBmAIIq965wENvXF9Atv2+7Q=',
      ua_launch_id: null,
      lobby_launch_id: null,
      entries: {
        navigation: [
          {
            name: 'https://localhost/frontend/everest/hotfix-release/#category=top_games&EVOSESSIONID=rcrn3246btshppior2cjwgncgevs7pswb7d66f6e7025ac97cc15806852f596d54b398fcc115f46f7&lang=ko&locale=ko',
            startTime: 0,
            duration: 765.9000000022352,
            initiatorType: 'navigation',
            deliveryType: '',
            nextHopProtocol: 'http/1.1',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 0.9000000022351742,
            domainLookupStart: 0.9000000022351742,
            domainLookupEnd: 0.9000000022351742,
            connectStart: 0.9000000022351742,
            secureConnectionStart: 0.9000000022351742,
            connectEnd: 0.9000000022351742,
            requestStart: 2.300000000745058,
            responseStart: 706.6000000014901,
            firstInterimResponseStart: 0,
            responseEnd: 707.5,
            transferSize: 204971,
            encodedBodySize: 204671,
            decodedBodySize: 204671,
            responseStatus: 200,
            serverTiming: [],
            unloadEventStart: 0,
            unloadEventEnd: 0,
            domInteractive: 761.9000000022352,
            domContentLoadedEventStart: 761.9000000022352,
            domContentLoadedEventEnd: 761.9000000022352,
            domComplete: 765.7000000029802,
            loadEventStart: 765.7000000029802,
            loadEventEnd: 765.9000000022352,
            type: 'navigate',
            redirectCount: 0,
            activationStart: 0,
            criticalCHRestart: 0,
          },
        ],
        'visibility-state': [{ name: 'visible', startTime: 0, duration: 0 }],
        resource: [
          {
            name: 'https://localhost/setup?device=desktop&wrapped=true&EVOSESSIONID=rcrn3246btshppior2cjwgncgevs7pswb7d66f6e7025ac97cc15806852f596d54b398fcc115f46f7&client_version=6.20240325.123015.40308-372eee56ec',
            startTime: 749.1000000014901,
            duration: 423.6000000014901,
            initiatorType: 'fetch',
            deliveryType: '',
            nextHopProtocol: 'http/1.1',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 749.1000000014901,
            domainLookupStart: 749.1000000014901,
            domainLookupEnd: 749.1000000014901,
            connectStart: 749.1000000014901,
            secureConnectionStart: 749.1000000014901,
            connectEnd: 749.1000000014901,
            requestStart: 749.9000000022352,
            responseStart: 1172,
            firstInterimResponseStart: 0,
            responseEnd: 1172.7000000029802,
            transferSize: 2178,
            encodedBodySize: 1878,
            decodedBodySize: 1878,
            responseStatus: 200,
            serverTiming: [],
          },
          {
            name: 'https://localhost/log?EVOSESSIONID=rcrn3246btshppior2cjwgncgevs7pswb7d66f6e7025ac97cc15806852f596d54b398fcc115f46f7&client_version=6.20240325.123015.40308-372eee56ec',
            startTime: 751.3000000007451,
            duration: 4.300000000745058,
            initiatorType: 'beacon',
            deliveryType: '',
            nextHopProtocol: 'http/1.1',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 751.3000000007451,
            domainLookupStart: 751.3000000007451,
            domainLookupEnd: 751.3000000007451,
            connectStart: 751.3000000007451,
            secureConnectionStart: 751.3000000007451,
            connectEnd: 751.3000000007451,
            requestStart: 752,
            responseStart: 755.4000000022352,
            firstInterimResponseStart: 0,
            responseEnd: 755.6000000014901,
            transferSize: 302,
            encodedBodySize: 2,
            decodedBodySize: 2,
            responseStatus: 200,
            serverTiming: [],
          },
          {
            name: 'https://static.egcdn.com/frontend/loc/strings/ko/smartlobby.json',
            startTime: 1177.4000000022352,
            duration: 2.899999998509884,
            initiatorType: 'fetch',
            deliveryType: '',
            nextHopProtocol: '',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 1177.4000000022352,
            domainLookupStart: 0,
            domainLookupEnd: 0,
            connectStart: 0,
            secureConnectionStart: 0,
            connectEnd: 0,
            requestStart: 0,
            responseStart: 0,
            firstInterimResponseStart: 0,
            responseEnd: 1180.300000000745,
            transferSize: 0,
            encodedBodySize: 0,
            decodedBodySize: 0,
            responseStatus: 200,
            serverTiming: [],
          },
        ],
        paint: [
          { name: 'first-paint', startTime: 755.8000000007451, duration: 0 },
          { name: 'first-contentful-paint', startTime: 1011.3000000007451, duration: 0 },
        ],
        mark: [
          { name: 'evoLoaderClosed', startTime: 1290.4000000022352, duration: 0 },
          { name: 'evoLobbySkeletonsHidden', startTime: 3835.300000000745, duration: 0 },
          { name: '_evoReportGenerated', startTime: 3835.900000002235, duration: 0 },
        ],
      },
      evoLoaderClosed: 1290.4000000022352,
      evoLobbySkeletonsHidden: 3835.300000000745,
    },
  },
}

const lobbyAppLoadingTimeV2ExpectPacket = {
  id: 'pk0p4kgu8u',
  type: 'lobby.appEvent',
  args: {
    type: 'CLIENT_APP_LOADING_TIME_V2',
    value: {
      userAgent:
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36 Edg/123.0.0.0',
      version: 14,
      game: 'smart-lobby',
      device: 'desktop',
      connectionType: '4g',
      build: '6.20240325.123015.40308-372eee56ec',
      attributionId: 'dRFCoCi3ju2JScBPEoAGBmAIIq965wENvXF9Atv2+7Q=',
      ua_launch_id: null,
      lobby_launch_id: null,
      entries: {
        navigation: [
          {
            name: 'https://babylonrd.evo-games.com/frontend/everest/hotfix-release/#category=top_games&EVOSESSIONID=rcrn3246btshppior2cjwgncgevs7pswb7d66f6e7025ac97cc15806852f596d54b398fcc115f46f7&lang=ko&locale=ko',
            startTime: 0,
            duration: 765.9000000022352,
            initiatorType: 'navigation',
            deliveryType: '',
            nextHopProtocol: 'http/1.1',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 0.9000000022351742,
            domainLookupStart: 0.9000000022351742,
            domainLookupEnd: 0.9000000022351742,
            connectStart: 0.9000000022351742,
            secureConnectionStart: 0.9000000022351742,
            connectEnd: 0.9000000022351742,
            requestStart: 2.300000000745058,
            responseStart: 706.6000000014901,
            firstInterimResponseStart: 0,
            responseEnd: 707.5,
            transferSize: 204971,
            encodedBodySize: 204671,
            decodedBodySize: 204671,
            responseStatus: 200,
            serverTiming: [],
            unloadEventStart: 0,
            unloadEventEnd: 0,
            domInteractive: 761.9000000022352,
            domContentLoadedEventStart: 761.9000000022352,
            domContentLoadedEventEnd: 761.9000000022352,
            domComplete: 765.7000000029802,
            loadEventStart: 765.7000000029802,
            loadEventEnd: 765.9000000022352,
            type: 'navigate',
            redirectCount: 0,
            activationStart: 0,
            criticalCHRestart: 0,
          },
        ],
        'visibility-state': [{ name: 'visible', startTime: 0, duration: 0 }],
        resource: [
          {
            name: 'https://babylonrd.evo-games.com/setup?device=desktop&wrapped=true&EVOSESSIONID=rcrn3246btshppior2cjwgncgevs7pswb7d66f6e7025ac97cc15806852f596d54b398fcc115f46f7&client_version=6.20240325.123015.40308-372eee56ec',
            startTime: 749.1000000014901,
            duration: 423.6000000014901,
            initiatorType: 'fetch',
            deliveryType: '',
            nextHopProtocol: 'http/1.1',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 749.1000000014901,
            domainLookupStart: 749.1000000014901,
            domainLookupEnd: 749.1000000014901,
            connectStart: 749.1000000014901,
            secureConnectionStart: 749.1000000014901,
            connectEnd: 749.1000000014901,
            requestStart: 749.9000000022352,
            responseStart: 1172,
            firstInterimResponseStart: 0,
            responseEnd: 1172.7000000029802,
            transferSize: 2178,
            encodedBodySize: 1878,
            decodedBodySize: 1878,
            responseStatus: 200,
            serverTiming: [],
          },
          {
            name: 'https://babylonrd.evo-games.com/log?EVOSESSIONID=rcrn3246btshppior2cjwgncgevs7pswb7d66f6e7025ac97cc15806852f596d54b398fcc115f46f7&client_version=6.20240325.123015.40308-372eee56ec',
            startTime: 751.3000000007451,
            duration: 4.300000000745058,
            initiatorType: 'beacon',
            deliveryType: '',
            nextHopProtocol: 'http/1.1',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 751.3000000007451,
            domainLookupStart: 751.3000000007451,
            domainLookupEnd: 751.3000000007451,
            connectStart: 751.3000000007451,
            secureConnectionStart: 751.3000000007451,
            connectEnd: 751.3000000007451,
            requestStart: 752,
            responseStart: 755.4000000022352,
            firstInterimResponseStart: 0,
            responseEnd: 755.6000000014901,
            transferSize: 302,
            encodedBodySize: 2,
            decodedBodySize: 2,
            responseStatus: 200,
            serverTiming: [],
          },
          {
            name: 'https://static.egcdn.com/frontend/loc/strings/ko/smartlobby.json',
            startTime: 1177.4000000022352,
            duration: 2.899999998509884,
            initiatorType: 'fetch',
            deliveryType: '',
            nextHopProtocol: '',
            renderBlockingStatus: 'non-blocking',
            workerStart: 0,
            redirectStart: 0,
            redirectEnd: 0,
            fetchStart: 1177.4000000022352,
            domainLookupStart: 0,
            domainLookupEnd: 0,
            connectStart: 0,
            secureConnectionStart: 0,
            connectEnd: 0,
            requestStart: 0,
            responseStart: 0,
            firstInterimResponseStart: 0,
            responseEnd: 1180.300000000745,
            transferSize: 0,
            encodedBodySize: 0,
            decodedBodySize: 0,
            responseStatus: 200,
            serverTiming: [],
          },
        ],
        paint: [
          { name: 'first-paint', startTime: 755.8000000007451, duration: 0 },
          { name: 'first-contentful-paint', startTime: 1011.3000000007451, duration: 0 },
        ],
        mark: [
          { name: 'evoLoaderClosed', startTime: 1290.4000000022352, duration: 0 },
          { name: 'evoLobbySkeletonsHidden', startTime: 3835.300000000745, duration: 0 },
          { name: '_evoReportGenerated', startTime: 3835.900000002235, duration: 0 },
        ],
      },
      evoLoaderClosed: 1290.4000000022352,
      evoLobbySkeletonsHidden: 3835.300000000745,
    },
  },
}

const evolutionUrl = new URL('https://babylonrd.evo-games.com/frontend/everest/hotfix-release/#category=top_games')

describe('websocket lobby url test', () => {
  test('lobbyClientGameLoadedPacket test', async () => {
    const packet = lobbyClientGameLoadedPacket

    changePacketHostname(packet, evolutionUrl.hostname)

    expect(packet).toStrictEqual(lobbyClientGameLoadedExpectPacket)

    console.log('end')
  })
  test('lobbyClientLobbyOpenedPacket test', async () => {
    const packet = lobbyClientLobbyOpenedPacket

    changePacketHostname(packet, evolutionUrl.hostname)

    expect(packet).toStrictEqual(lobbyClientLobbyOpenedExpectPacket)

    console.log('end')
  })
  test('lobbyAppLoadingTimeV2Packet test', async () => {
    const packet = lobbyAppLoadingTimeV2Packet

    changePacketHostname(packet, evolutionUrl.hostname)

    expect(packet).toStrictEqual(lobbyAppLoadingTimeV2ExpectPacket)

    console.log('end')
  })
})
